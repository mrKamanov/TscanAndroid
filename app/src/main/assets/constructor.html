<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.5, maximum-scale=0.5, minimum-scale=0.5, user-scalable=yes">
    <title>Конструктор бланков</title>

    <!-- Локальные библиотеки -->
    <script src="js/html2canvas.min.js"></script>
    <script src="js/libraries.js"></script>
    <script>
        // Проверяем загрузку библиотек
        window.addEventListener('load', function() {
            console.log('Constructor: Checking library availability...');
            
            if (typeof html2canvas !== 'undefined') {
                console.log('Constructor: html2canvas loaded successfully');
            } else {
                console.error('Constructor: html2canvas not loaded!');
            }
            

            
            if (window.Android && window.Android.log) {
                window.Android.log('Libraries check completed');
            }
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'krabuler', sans-serif;
            background: #2E3440;
            min-height: 100vh;
            color: #ECEFF4;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #ECEFF4;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #5E81AC;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.8;
            font-weight: 300;
            color: #D8DEE9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .settings-panel {
            background: #3B4252;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            height: fit-content;
            border: 1px solid #4C566A;
        }

        .panel-section {
            margin-bottom: 30px;
        }

        .panel-section h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #ECEFF4;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-section h3 i {
            color: #5E81AC;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #D8DEE9;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #4C566A;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: #2E3440;
            color: #ECEFF4;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #5E81AC;
            background: #2E3440;
            box-shadow: 0 0 0 3px rgba(94, 129, 172, 0.1);
        }

        /* Стили для скрытых полей */
        .form-group.hidden input {
            opacity: 0.5;
            background: #434C5E;
            border-color: #5C6A7A;
            color: #9CA3AF;
        }

        .form-group.hidden .field-header label {
            color: #9CA3AF;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            justify-content: center;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #5E81AC 0%, #4C6A8C 100%);
            color: #ECEFF4;
            box-shadow: 0 4px 15px rgba(94, 129, 172, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(94, 129, 172, 0.4);
        }

        .form-preview {
            background: #3B4252;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid #4C566A;
        }

        .form-preview h3 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #ECEFF4;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-preview h3 i {
            color: #5E81AC;
        }

        .form-parameters {
            background: #3B4252;
            border: 1px solid #4C566A;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .parameter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .parameter-group label {
            color: #D8DEE9;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .parameter-group input {
            padding: 8px 12px;
            border: 2px solid #4C566A;
            background: #2E3440;
            color: #ECEFF4;
            border-radius: 6px;
            font-size: 0.9rem;
            width: 120px;
        }

        .parameter-group input:focus {
            border-color: #5E81AC;
            outline: none;
            box-shadow: 0 0 0 3px rgba(94, 129, 172, 0.1);
        }

        .parameter-group input::-webkit-outer-spin-button,
        .parameter-group input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .parameter-group input[type=number] {
            -moz-appearance: textfield;
        }

        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #3B4252;
            border-radius: 6px;
            background-color: #2E3440;
            color: #ECEFF4;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-select:focus {
            border-color: #5E81AC;
            outline: none;
            box-shadow: 0 0 0 3px rgba(94, 129, 172, 0.1);
        }

        .form-select option {
            background-color: #2E3440;
            color: #ECEFF4;
        }

        .form-container {
            position: relative;
            background: white;
            border: 2px solid #2E3440;
            border-radius: 8px;
            width: 595px;
            height: 842px;
            margin: 0 auto;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }

        .form-container.updating {
            box-shadow: 0 4px 15px rgba(94, 129, 172, 0.4);
            border-color: #5E81AC;
        }

        /* Панель управления масштабом */
        .zoom-control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #3B4252;
            border: 1px solid #4C566A;
            border-radius: 8px;
            padding: 20px;
            width: 300px;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .zoom-control-panel h3 {
            color: #ECEFF4;
            margin: 0 0 15px 0;
            font-size: 1.1rem;
        }

        .zoom-control-panel h3 i {
            color: #5E81AC;
            margin-right: 8px;
        }

        .zoom-controls {
            margin-bottom: 15px;
        }

        .control-group {
            margin-bottom: 10px;
        }

        .control-group label {
            display: block;
            color: #D8DEE9;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .control-group input {
            width: 100%;
            padding: 8px;
            border: 2px solid #4C566A;
            background: #2E3440;
            color: #ECEFF4;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .control-group input:focus {
            border-color: #5E81AC;
            outline: none;
        }

        .control-group input[readonly] {
            background: #4C566A;
            color: #D8DEE9;
        }

        .zoom-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .zoom-actions .btn {
            flex: 1;
            min-width: 80px;
            padding: 8px 12px;
            font-size: 0.8rem;
        }

        .form-element {
            position: absolute;
            cursor: move;
            user-select: none;
            border: 2px solid transparent;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .form-element:hover {
            border-color: #5E81AC;
            box-shadow: 0 0 10px rgba(94, 129, 172, 0.3);
        }

        .form-element.selected {
            border-color: #5E81AC;
            box-shadow: 0 0 15px rgba(94, 129, 172, 0.5);
        }

        .resize-handle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #5E81AC;
            border-radius: 50%;
            cursor: nw-resize;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .form-element:hover .resize-handle,
        .form-element.selected .resize-handle {
            opacity: 1;
        }

        .resize-handle.nw { top: -4px; left: -4px; cursor: nw-resize; }
        .resize-handle.ne { top: -4px; right: -4px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -4px; left: -4px; cursor: sw-resize; }
        .resize-handle.se { bottom: -4px; right: -4px; cursor: se-resize; }

        .title-element {
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            color: #2E3440;
        }

        .info-element {
            font-size: 18px;
            color: #4C566A;
            margin-bottom: 10px;
        }

        .bubbles-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            border: 3px solid #2E3440;
            box-sizing: border-box;
        }

        .column-container {
            border: 3px solid #2E3440;
            background: white;
            padding: 5px;
            box-sizing: border-box;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .bubbles-grid.two-columns {
            flex-direction: row !important;
            justify-content: flex-start !important;
            gap: 20px !important;
            flex-wrap: nowrap;
            border: none !important; 
            background: transparent !important;
            padding: 0 !important;
        }

        .empty-bubble {
            opacity: 0.3 !important;
            background-color: #f0f0f0 !important;
            border-color: #ccc !important;
            cursor: default !important;
        }

        .empty-bubble:hover {
            transform: none !important;
            background-color: #f0f0f0 !important;
        }

        .bubble {
            width: 50px;
            height: 50px;
            border: 3px solid #2E3440;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: #2E3440;
            background: white;
            cursor: pointer;
        }

        .action-buttons {
            display: flex;
            flex-direction: row;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            padding: 20px;
        }

        .action-button {
            width: 140px;
            height: 48px;
            border: none;
            border-radius: 24px;
            background: #1E293B;
            color: #CBD5E1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            font-family: 'krabuler', sans-serif;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            border: 2px solid #475569;
            position: relative;
            padding: 0 24px;
        }

        .action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .action-button.save-image { 
            background: #16A34A; 
            color: #FFFFFF;
            border: 2px solid #475569;
        }
        
        .action-button.save-png { 
            background: #1E293B; 
            color: #CBD5E1;
            border: 2px solid #475569;
        }
        
        .action-button.save-image:hover { 
            background: #15803D; 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
        }
        
        .action-button.save-png:hover { 
            background: #334155; 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(30, 41, 59, 0.3);
        }

        .object-control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #3B4252;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            min-width: 320px;
            display: none;
            border: 1px solid #4C566A;
        }

        .object-control-panel h4 {
            margin-bottom: 15px;
            color: #ECEFF4;
        }

        .object-control-panel h4 i {
            color: #5E81AC;
            margin-right: 8px;
        }

        .control-sliders {
            margin-bottom: 15px;
        }

        .slider-group {
            margin-bottom: 15px;
        }

        .slider-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #D8DEE9;
        }

        .slider-group label span {
            color: #5E81AC;
            font-weight: 600;
        }

        .slider {
            width: 100%;
            height: 12px;
            border-radius: 6px;
            background: #4C566A;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #5E81AC;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
        }

        .slider::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #5E81AC;
            cursor: pointer;
            border: none;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
        }

        .slider:focus {
            box-shadow: 0 0 0 3px rgba(94, 129, 172, 0.2);
        }

        .control-actions {
            display: flex;
            gap: 8px;
        }

        .control-actions .btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.8rem;
        }

       
        .selection-handle {
            transition: all 0.2s ease;
        }

        .selection-handle:hover {
            background-color: #81A1C1 !important;
            transform: translateY(-50%) scale(1.1) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4) !important;
        }

        .form-element.selected .selection-handle {
            background-color: #81A1C1 !important;
            border-color: #ECEFF4 !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4) !important;
        }

        
        .field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .field-header label {
            margin-bottom: 0;
            flex: 1;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input[type="checkbox"] {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-label {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4C566A;
            transition: 0.3s;
            border-radius: 24px;
            border: 1px solid #5C6A7A;
        }

        .toggle-label:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: #ECEFF4;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch input:checked + .toggle-label {
            background-color: #16A34A;
            border-color: #16A34A;
        }

        .toggle-switch input:checked + .toggle-label:before {
            transform: translateX(26px);
        }

        .toggle-switch input:focus + .toggle-label {
            box-shadow: 0 0 1px #16A34A;
        }

        
        .collapsible-group {
            margin-bottom: 15px;
            border: 1px solid #4C566A;
            border-radius: 8px;
            overflow: hidden;
            background: #3B4252;
        }

        .group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: #434C5E;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid #4C566A;
        }

        .group-header:hover {
            background: #4C566A;
        }

        .group-header h3 {
            margin: 0;
            color: #ECEFF4;
            font-size: 1rem;
            font-weight: 600;
        }

        .group-header .header-content {
            display: flex;
            align-items: center;
        }

        .group-header i {
            color: #5E81AC;
            margin-right: 8px;
        }

        .group-toggle {
            color: #D8DEE9;
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .group-toggle.rotated {
            transform: rotate(180deg);
        }

        .group-content {
            padding: 15px;
            transition: all 0.3s ease;
            max-height: 1000px;
            overflow: hidden;
        }

        .group-content.collapsed {
            max-height: 0;
            padding: 0 15px;
        }

        
        .master-toggle {
            margin-bottom: 20px;
            padding: 15px;
            background: #434C5E;
            border-radius: 8px;
            border: 1px solid #4C566A;
        }

        .master-toggle .field-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0;
        }

        .master-toggle .field-header label {
            color: #ECEFF4;
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .settings-panel {
                order: 2;
            }
            
            .form-preview {
                order: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Конструктор бланков</h1>
            <p>Создавайте бланки для тестирования</p>
        </div>

        <div class="main-content">
            
            <div class="settings-panel">
                <div class="panel-section">
                    <h3>⚙️ Настройки бланка</h3>
                    <p style="color: #D8DEE9; font-size: 0.9rem; margin-bottom: 20px; opacity: 0.8;">
                        Все изменения применяются автоматически
                    </p>
                </div>
                <div class="collapsible-group">
                    <div class="group-header" onclick="toggleGroup('text-elements')">
                        <div class="header-content">
                            <span>✏️</span>
                            <h3>Текстовые элементы</h3>
                        </div>
                        <span class="group-toggle">▼</span>
                    </div>
                    <div class="group-content" id="text-elements-content">
                        <div class="master-toggle">
                            <div class="field-header">
                                <label for="master-text-toggle">Показать/скрыть все текстовые элементы</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="master-text-toggle" checked>
                                    <label for="master-text-toggle" class="toggle-label"></label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="field-header">
                                <label for="title">Заголовок:</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="title-toggle" checked>
                                    <label for="title-toggle" class="toggle-label"></label>
                                </div>
                            </div>
                            <input type="text" id="title" value="ТЕСТ">
                        </div>
                        <div class="form-group">
                            <div class="field-header">
                                <label for="student_name">ФИО:</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="student_name-toggle" checked>
                                    <label for="student_name-toggle" class="toggle-label"></label>
                                </div>
                            </div>
                            <input type="text" id="student_name" value="ФИО: _________________">
                        </div>
                        <div class="form-group">
                            <div class="field-header">
                                <label for="subject">Предмет:</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="subject-toggle" checked>
                                    <label for="subject-toggle" class="toggle-label"></label>
                                </div>
                            </div>
                            <input type="text" id="subject" value="Предмет: _________________">
                        </div>
                        <div class="form-group">
                            <div class="field-header">
                                <label for="date">Дата:</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="date-toggle" checked>
                                    <label for="date-toggle" class="toggle-label"></label>
                                </div>
                            </div>
                            <input type="text" id="date" value="Дата: _________________">
                        </div>
                        <div class="form-group">
                            <div class="field-header">
                                <label for="instruction">Инструкция:</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="instruction-toggle" checked>
                                    <label for="instruction-toggle" class="toggle-label"></label>
                                </div>
                            </div>
                            <input type="text" id="instruction" value="Инструкция: Закрасьте правильные ответы">
                        </div>
                    </div>
                </div>

                <div class="collapsible-group">
                    <div class="group-header" onclick="toggleGroup('sizes')">
                        <div class="header-content">
                            <span>📏</span>
                            <h3>Размеры элементов</h3>
                        </div>
                        <span class="group-toggle rotated">▲</span>
                    </div>
                    <div class="group-content collapsed" id="sizes-content">
                        <div class="form-group">
                            <label for="bubble_size">Размер кружков (px):</label>
                            <input type="number" id="bubble_size" min="20" max="80" value="30">
                        </div>
                        <div class="form-group">
                            <label for="font_size">Размер шрифта (px):</label>
                            <input type="number" id="font_size" min="10" max="30" value="15">
                        </div>
                    </div>
                </div>

                <div class="collapsible-group">
                    <div class="group-header" onclick="toggleGroup('spacing')">
                        <div class="header-content">
                            <span>🎚️</span>
                            <h3>Отступы и интервалы</h3>
                        </div>
                        <span class="group-toggle rotated">▲</span>
                    </div>
                    <div class="group-content collapsed" id="spacing-content">
                        <div class="form-group">
                            <label for="cell_gap_horizontal">Горизонтальный отступ между кружками (px):</label>
                            <input type="number" id="cell_gap_horizontal" min="5" max="50" value="10">
                        </div>
                        <div class="form-group">
                            <label for="cell_gap_vertical">Вертикальный отступ между кружками (px):</label>
                            <input type="number" id="cell_gap_vertical" min="5" max="50" value="10">
                        </div>
                        <div class="form-group">
                            <label for="grid_padding">Отступ от края сетки (px):</label>
                            <input type="number" id="grid_padding" min="5" max="50" value="5">
                        </div>
                        <div class="form-group">
                            <label for="border_width">Толщина линии контура (px):</label>
                            <input type="number" id="border_width" min="1" max="20" value="7">
                        </div>
                    </div>
                </div>

                
            </div>

            
            <div class="form-preview">
                <h3>👁️ Лист А4</h3>
                <div class="form-parameters">
                    <div class="parameter-group">
                        <label for="questions">Количество вопросов:</label>
                        <input type="number" id="questions" value="10" min="1" max="35" step="1" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    </div>
                    <div class="parameter-group">
                        <label for="options">Вариантов ответа:</label>
                        <input type="number" id="options" value="5" min="2" max="9" step="1" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    </div>
                    <div class="parameter-group">
                        <label for="columns">Количество столбцов:</label>
                        <select id="columns" class="form-select">
                            <option value="1">1 столбец</option>
                            <option value="2">2 столбца</option>
                        </select>
                    </div>
                </div>
                <div class="form-container" id="form-container">
                    
                </div>
                
                
                <div class="action-buttons">
                    <button class="action-button save-image" id="save-image" title="Сохранить PNG с белым фоном">
                        🖼️ PNG фон
                    </button>
                    <button class="action-button save-png" id="save-png" title="Сохранить PNG без фона - прозрачный">
                        🔳 PNG без фона
                    </button>
                </div>
            </div>
        </div>
    </div>

    
    <div class="object-control-panel" id="object-control-panel">
        <h4>↔️ Управление объектом</h4>
        <div class="control-sliders">
            <div class="slider-group">
                <label for="slider-x">Позиция X: <span id="slider-x-value">0</span>px</label>
                <input type="range" id="slider-x" min="0" max="500" value="0" class="slider">
            </div>
            <div class="slider-group">
                <label for="slider-y">Позиция Y: <span id="slider-y-value">0</span>px</label>
                <input type="range" id="slider-y" min="0" max="800" value="0" class="slider">
            </div>
            <div class="slider-group">
                <label for="slider-font-size">Размер шрифта: <span id="slider-font-size-value">15</span>px</label>
                <input type="range" id="slider-font-size" min="8" max="50" value="15" class="slider">
            </div>
            <div class="slider-group">
                <label for="slider-scale">Масштаб: <span id="slider-scale-value">100</span>%</label>
                <input type="range" id="slider-scale" min="50" max="200" value="100" class="slider">
            </div>
        </div>
        <div class="control-actions">
            <button class="btn btn-secondary" id="reset-object">
                ↶ Сбросить
            </button>
            <button class="btn btn-primary" id="apply-object">
                ✓ Применить
            </button>
        </div>
    </div>


    <script>
        
        const formContainer = document.getElementById('form-container');
        const objectControlPanel = document.getElementById('object-control-panel');
        
        
        const titleInput = document.getElementById('title');
        const studentNameInput = document.getElementById('student_name');
        const subjectInput = document.getElementById('subject');
        const dateInput = document.getElementById('date');
        const instructionInput = document.getElementById('instruction');
        const questionsInput = document.getElementById('questions');
        const optionsInput = document.getElementById('options');
        const bubbleSizeInput = document.getElementById('bubble_size');
        const fontSizeInput = document.getElementById('font_size');

        
        let selectedElement = null;
        let isDragging = false;
        let isResizing = false;
        let resizeHandle = null;
        let startX = 0;
        let startY = 0;
        let startWidth = 0;
        let startHeight = 0;
        let startLeft = 0;
        let startTop = 0;

        
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('Constructor: DOM loaded, initializing...');
                
                
                if (window.Android) {
                    console.log('Constructor: Android interface available');
                    if (window.Android.log) {
                        window.Android.log('Constructor initialized successfully');
                    }
                } else {
                    console.warn('Constructor: Android interface not available');
                }
                
                setupEventListeners();
                setupMasterTextToggle();
                generateForm();
            } catch (error) {
                console.error('Constructor: Initialization error:', error);
                if (window.Android && window.Android.log) {
                    window.Android.log('Constructor init error: ' + error.message);
                }
            }
        });



        
        function setOptimalZoom() {
           
        }



        
        function toggleGroup(groupId) {
            const content = document.getElementById(groupId + '-content');
            const toggle = content.previousElementSibling.querySelector('.group-toggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.textContent = '▼';
                toggle.classList.remove('rotated');
            } else {
                content.classList.add('collapsed');
                toggle.textContent = '▲';
                toggle.classList.add('rotated');
            }
        }

        
        function setupMasterTextToggle() {
            const masterToggle = document.getElementById('master-text-toggle');
            const textToggles = [
                'title-toggle',
                'student_name-toggle', 
                'subject-toggle',
                'date-toggle',
                'instruction-toggle'
            ];

            if (!masterToggle) {
                console.error('Constructor: Master text toggle not found');
                return;
            }

            console.log('Constructor: Setting up master text toggle');

            masterToggle.addEventListener('change', function() {
                const isChecked = this.checked;
                console.log('Constructor: Master toggle changed to:', isChecked);
                
                textToggles.forEach(toggleId => {
                    const toggle = document.getElementById(toggleId);
                    if (toggle) {
                        toggle.checked = isChecked;
                        
                        toggle.dispatchEvent(new Event('change', { bubbles: true }));
                    } else {
                        console.warn(`Constructor: Toggle ${toggleId} not found`);
                    }
                });
            });

            
            textToggles.forEach(toggleId => {
                const toggle = document.getElementById(toggleId);
                if (toggle) {
                    toggle.addEventListener('change', function() {
                        const allChecked = textToggles.every(id => {
                            const el = document.getElementById(id);
                            return el && el.checked;
                        });
                        if (masterToggle) {
                            masterToggle.checked = allChecked;
                        }
                    });
                } else {
                    console.warn(`Constructor: Individual toggle ${toggleId} not found`);
                }
            });
        }

        function setupEventListeners() {
            console.log('Constructor: Setting up event listeners...');
            
            
            const saveImageBtn = document.getElementById('save-image');
            const savePngBtn = document.getElementById('save-png');
            
            if (saveImageBtn) {
                saveImageBtn.addEventListener('click', function() {
                    console.log('Constructor: Image save button clicked via event listener');
                    saveAsImage();
                });
            } else {
                console.error('Constructor: Image save button not found');
            }
            
            if (savePngBtn) {
                savePngBtn.addEventListener('click', function() {
                    console.log('Constructor: PNG save button clicked via event listener');
                    saveAsPNG();
                });
            } else {
                console.error('Constructor: PNG save button not found');
            }

            
            setupObjectControlSliders();

            
            [titleInput, studentNameInput, subjectInput, dateInput, instructionInput, 
             questionsInput, optionsInput, bubbleSizeInput, fontSizeInput,
             document.getElementById('cell_gap_horizontal'), document.getElementById('cell_gap_vertical'), 
             document.getElementById('grid_padding'), document.getElementById('border_width')].forEach(input => {
                input.addEventListener('input', generateForm);
            });

            
            document.getElementById('columns').addEventListener('change', generateForm);

            
            [titleInput, studentNameInput, subjectInput, dateInput, instructionInput].forEach(input => {
                input.addEventListener('input', debounce(generateForm, 100));
            });

            
            ['title-toggle', 'student_name-toggle', 'subject-toggle', 'date-toggle', 'instruction-toggle'].forEach(toggleId => {
                const toggle = document.getElementById(toggleId);
                const fieldName = toggleId.replace('-toggle', '');
                const formGroup = toggle.closest('.form-group');
                
                toggle.addEventListener('change', function() {
                    
                    if (this.checked) {
                        formGroup.classList.remove('hidden');
                    } else {
                        formGroup.classList.add('hidden');
                    }
                    
                    
                    generateForm();
                });
                
                
                if (!toggle.checked) {
                    formGroup.classList.add('hidden');
                }
            });

            
            setTimeout(() => {
                ['title-toggle', 'student_name-toggle', 'subject-toggle', 'date-toggle', 'instruction-toggle'].forEach(toggleId => {
                    const toggle = document.getElementById(toggleId);
                    if (toggle) {
                        const event = new Event('change');
                        toggle.dispatchEvent(event);
                    }
                });
                
                
                setTimeout(() => {
                    generateForm();
                }, 200);
            }, 1000);



            
            setupZoomControlPanel();
        }

        
        function setupObjectControlSliders() {
            const sliders = {
                x: document.getElementById('slider-x'),
                y: document.getElementById('slider-y'),
                fontSize: document.getElementById('slider-font-size'),
                scale: document.getElementById('slider-scale')
            };

            const values = {
                x: document.getElementById('slider-x-value'),
                y: document.getElementById('slider-y-value'),
                fontSize: document.getElementById('slider-font-size-value'),
                scale: document.getElementById('slider-scale-value')
            };

            
            Object.keys(sliders).forEach(key => {
                const slider = sliders[key];
                const value = values[key];
                
                if (slider && value) {
                    slider.addEventListener('input', function() {
                        value.textContent = this.value;
                        if (key === 'scale') {
                            value.textContent = this.value + '%';
                        } else {
                            value.textContent = this.value + 'px';
                        }
                        
                        
                        if (selectedElement) {
                            applySliderChanges(key, this.value);
                        }
                    });
                }
            });

            
            document.getElementById('reset-object').addEventListener('click', function() {
                if (selectedElement) {
                    resetObjectToDefaults();
                }
            });

            
            document.getElementById('apply-object').addEventListener('click', function() {
                if (selectedElement) {
                    applyObjectChanges();
                }
            });
        }

        
        function applySliderChanges(property, value) {
            if (!selectedElement) return;

            const numValue = parseFloat(value);
            
            switch(property) {
                case 'x':
                    selectedElement.style.left = numValue + 'px';
                    break;
                case 'y':
                    selectedElement.style.top = numValue + 'px';
                    break;
                case 'fontSize':
                    selectedElement.style.fontSize = numValue + 'px';
                    break;
                case 'scale':
                    const scale = numValue / 100;
                    selectedElement.style.transform = `scale(${scale})`;
                    break;
            }
        }

        
        function resetObjectToDefaults() {
            if (!selectedElement) return;

            const defaults = {
                x: 50,
                y: 50,
                'font-size': 15,
                scale: 100
            };

            Object.keys(defaults).forEach(key => {
                const slider = document.getElementById(`slider-${key}`);
                const value = document.getElementById(`slider-${key}-value`);
                
                if (!slider) {
                    console.warn(`Constructor: Slider element 'slider-${key}' not found`);
                    return;
                }
                if (!value) {
                    console.warn(`Constructor: Value element 'slider-${key}-value' not found`);
                    return;
                }
                
                try {
                    slider.value = defaults[key];
                    if (key === 'scale') {
                        value.textContent = defaults[key] + '%';
                    } else {
                        value.textContent = defaults[key] + 'px';
                    }
                    applySliderChanges(key, defaults[key]);
                } catch (error) {
                    console.error(`Constructor: Error resetting slider ${key}:`, error);
                }
            });
        }

        
        function applyObjectChanges() {
            if (!selectedElement) return;
            

        }

        
        function setupZoomControlPanel() {
            const initialScaleInput = document.getElementById('initial-scale');
            const minScaleInput = document.getElementById('min-scale');
            const maxScaleInput = document.getElementById('max-scale');
            const currentScaleInput = document.getElementById('current-scale');
            const applyButton = document.getElementById('apply-zoom');
            const resetButton = document.getElementById('reset-zoom');
            const copyButton = document.getElementById('copy-zoom');

            
            if (!currentScaleInput) {
                console.warn('Constructor: Current scale input element not found');
                return;
            }

            
            setInterval(() => {
                try {
                    const viewport = document.querySelector('meta[name="viewport"]');
                    const scaleMatch = viewport.getAttribute('content').match(/initial-scale=([\d.]+)/);
                    const currentScale = scaleMatch ? parseFloat(scaleMatch[1]) : 1;
                    if (currentScaleInput) {
                        currentScaleInput.value = currentScale.toFixed(3);
                    }
                } catch (error) {
                    console.error('Constructor: Error updating current scale:', error);
                }
            }, 500);

            
            applyButton.addEventListener('click', function() {
                const initialScale = parseFloat(initialScaleInput.value);
                const minScale = parseFloat(minScaleInput.value);
                const maxScale = parseFloat(maxScaleInput.value);

                const viewport = document.querySelector('meta[name="viewport"]');
                const newContent = `width=device-width, initial-scale=${initialScale}, maximum-scale=${maxScale}, minimum-scale=${minScale}, user-scalable=yes`;
                viewport.setAttribute('content', newContent);



            });

            
            resetButton.addEventListener('click', function() {
                initialScaleInput.value = '0.6';
                minScaleInput.value = '0.2';
                maxScaleInput.value = '3.0';
                
                const viewport = document.querySelector('meta[name="viewport"]');
                const newContent = 'width=device-width, initial-scale=0.6, maximum-scale=3, minimum-scale=0.2, user-scalable=yes';
                viewport.setAttribute('content', newContent);



            });

            
            copyButton.addEventListener('click', function() {
                const initialScale = initialScaleInput.value;
                const minScale = minScaleInput.value;
                const maxScale = maxScaleInput.value;
                const currentScale = currentScaleInput.value;

                const settings = {
                    initialScale: parseFloat(initialScale),
                    minScale: parseFloat(minScale),
                    maxScale: parseFloat(maxScale),
                    currentScale: parseFloat(currentScale)
                };

                console.log('Constructor: ZOOM SETTINGS FOR ANDROID:', settings);


            });
        }

        function generateForm() {
            
            formContainer.classList.add('updating');
            
            formContainer.innerHTML = '';
            
            const title = titleInput.value || 'ТЕСТ';
            const studentName = studentNameInput.value || 'ФИО: _________________';
            const subject = subjectInput.value || 'Предмет: _________________';
            const date = dateInput.value || 'Дата: _________________';
            const instruction = instructionInput.value || 'Инструкция: Закрасьте правильные ответы';
            const questions = parseInt(questionsInput.value) || 10;
            const options = parseInt(optionsInput.value) || 5;
            const columns = parseInt(document.getElementById('columns').value) || 1;
            const bubbleSize = parseInt(bubbleSizeInput.value) || 30;
            const fontSize = parseInt(fontSizeInput.value) || 15;
            const cellGapHorizontal = parseInt(document.getElementById('cell_gap_horizontal').value) || 10;
            const cellGapVertical = parseInt(document.getElementById('cell_gap_vertical').value) || 10;
            const gridPadding = parseInt(document.getElementById('grid_padding').value) || 5;
            const borderWidth = parseInt(document.getElementById('border_width').value) || 7;

            // Проверяем состояние переключателей с защитой от ошибок
            const titleToggle = document.getElementById('title-toggle');
            const studentNameToggle = document.getElementById('student_name-toggle');
            const subjectToggle = document.getElementById('subject-toggle');
            const dateToggle = document.getElementById('date-toggle');
            const instructionToggle = document.getElementById('instruction-toggle');
            
            const titleVisible = titleToggle ? titleToggle.checked : true;
            const studentNameVisible = studentNameToggle ? studentNameToggle.checked : true;
            const subjectVisible = subjectToggle ? subjectToggle.checked : true;
            const dateVisible = dateToggle ? dateToggle.checked : true;
            const instructionVisible = instructionToggle ? instructionToggle.checked : true;
            


            
            if (titleVisible) {
                createElement('title', title, 50, 50, 495, 60, fontSize * 1.5, 'title-element');
            }
            if (studentNameVisible) {
                createElement('student-name', studentName, 50, 150, 495, 30, fontSize, 'info-element');
            }
            if (subjectVisible) {
                createElement('subject', subject, 50, 200, 495, 30, fontSize, 'info-element');
            }
            if (dateVisible) {
                createElement('date', date, 50, 250, 495, 30, fontSize, 'info-element');
            }
            if (instructionVisible) {
                createElement('instruction', instruction, 50, 300, 495, 30, fontSize, 'info-element');
            }
            
            
            createBubblesGrid(questions, options, columns, bubbleSize, fontSize, cellGapHorizontal, cellGapVertical, gridPadding, borderWidth);
            
            
            selectedElement = null;
            objectControlPanel.style.display = 'none';
            
            
            setTimeout(() => {
                formContainer.classList.remove('updating');
            }, 200);
        }

        function createElement(type, text, x, y, width, height, fontSize, className) {
            const element = document.createElement('div');
            element.className = `form-element ${className}`;
            element.dataset.type = type;
            element.textContent = text;
            element.style.left = x + 'px';
            element.style.top = y + 'px';
            element.style.width = width + 'px';
            element.style.height = height + 'px';
            element.style.fontSize = fontSize + 'px';
            element.style.position = 'absolute';

            
            const resizeHandles = ['nw', 'ne', 'sw', 'se'];
            resizeHandles.forEach(pos => {
                const handle = document.createElement('div');
                handle.className = `resize-handle ${pos}`;
                element.appendChild(handle);
            });

            
            const selectionHandle = document.createElement('div');
            selectionHandle.className = 'selection-handle';
            selectionHandle.innerHTML = '⋮';
            selectionHandle.style.position = 'absolute';
            selectionHandle.style.left = '-25px';
            selectionHandle.style.top = '50%';
            selectionHandle.style.transform = 'translateY(-50%)';
            selectionHandle.style.width = '20px';
            selectionHandle.style.height = '20px';
            selectionHandle.style.backgroundColor = '#5E81AC';
            selectionHandle.style.border = '2px solid #4C566A';
            selectionHandle.style.borderRadius = '50%';
            selectionHandle.style.cursor = 'pointer';
            selectionHandle.style.zIndex = '10';
            selectionHandle.style.display = 'flex';
            selectionHandle.style.alignItems = 'center';
            selectionHandle.style.justifyContent = 'center';
            selectionHandle.style.color = '#ECEFF4';
            selectionHandle.style.fontSize = '10px';
            selectionHandle.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
            
            
            selectionHandle.dataset.hideOnSave = 'true';
            
            element.appendChild(selectionHandle);

            
            addElementEventListeners(element);
            
            formContainer.appendChild(element);
            return element;
        }

        function createBubblesGrid(questions, options, columns, bubbleSize, fontSize, cellGapHorizontal, cellGapVertical, gridPadding, borderWidth) {
            const grid = document.createElement('div');
            grid.className = 'form-element bubbles-grid';
            grid.dataset.type = 'bubbles-grid';
            grid.style.left = '50px';
            grid.style.top = '400px';
            grid.style.width = 'fit-content';
            grid.style.height = 'fit-content';
            grid.style.position = 'absolute';
            grid.style.padding = gridPadding + 'px';
            grid.style.borderWidth = borderWidth + 'px';
            grid.style.display = 'flex';
            grid.style.flexDirection = columns === 2 ? 'row' : 'column';
            grid.style.justifyContent = 'space-between';
            grid.style.gap = columns === 2 ? '20px' : '0px';
            
            
            if (columns === 2) {
                grid.classList.add('two-columns');
                
                grid.style.border = 'none';
                grid.style.background = 'transparent';
                grid.style.padding = '0px';
            } else {
                grid.classList.remove('two-columns');
                
                grid.style.border = borderWidth + 'px solid #2E3440';
                grid.style.background = 'white';
                grid.style.padding = gridPadding + 'px';
            }

            
            const resizeHandles = ['nw', 'ne', 'sw', 'se'];
            resizeHandles.forEach(pos => {
                const handle = document.createElement('div');
                handle.className = `resize-handle ${pos}`;
                grid.appendChild(handle);
            });

            
            const selectionHandle = document.createElement('div');
            selectionHandle.className = 'selection-handle';
            selectionHandle.innerHTML = '⋮';
            selectionHandle.style.position = 'absolute';
            selectionHandle.style.left = '-25px';
            selectionHandle.style.top = '50%';
            selectionHandle.style.transform = 'translateY(-50%)';
            selectionHandle.style.width = '20px';
            selectionHandle.style.height = '20px';
            selectionHandle.style.backgroundColor = '#5E81AC';
            selectionHandle.style.border = '2px solid #4C566A';
            selectionHandle.style.borderRadius = '50%';
            selectionHandle.style.cursor = 'pointer';
            selectionHandle.style.zIndex = '10';
            selectionHandle.style.display = 'flex';
            selectionHandle.style.alignItems = 'center';
            selectionHandle.style.justifyContent = 'center';
            selectionHandle.style.color = '#ECEFF4';
            selectionHandle.style.fontSize = '10px';
            selectionHandle.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
            
            
            selectionHandle.dataset.hideOnSave = 'true';
            
            grid.appendChild(selectionHandle);

            
            const availableWidth = 300 - (gridPadding * 2);
            const availableHeight = 300 - (gridPadding * 2);
            
            
            const containerWidth = (bubbleSize * options) + (cellGapHorizontal * (options - 1));
            const containerHeight = (bubbleSize * questions) + (cellGapVertical * (questions - 1));
            
            
            const bubblesContainer = document.createElement('div');
            bubblesContainer.style.position = 'relative';
            bubblesContainer.style.width = containerWidth + 'px';
            bubblesContainer.style.height = containerHeight + 'px';
            
            
            if (columns === 2) {
                const firstHalf = Math.ceil(questions / 2); 
                const secondHalf = questions - firstHalf;
                

                
                
                const firstColumn = createColumnContainer(firstHalf, options, bubbleSize, fontSize, cellGapHorizontal, cellGapVertical, gridPadding, borderWidth, 1);
                grid.appendChild(firstColumn);
                
                
                if (secondHalf > 0) {
                    const secondColumn = createColumnContainer(secondHalf, options, bubbleSize, fontSize, cellGapHorizontal, cellGapVertical, gridPadding, borderWidth, firstHalf + 1);
                    
                    
                    if (secondHalf < firstHalf) {
                        addEmptyRowToContainer(secondColumn, options, bubbleSize, fontSize, cellGapHorizontal, cellGapVertical);
                    }
                    
                    grid.appendChild(secondColumn);
                }
            } else {
                
                createBubblesInContainer(bubblesContainer, questions, options, bubbleSize, fontSize, cellGapHorizontal, cellGapVertical, 1);
                grid.appendChild(bubblesContainer);
            }
            


            
            grid.dataset.originalBubbleSize = bubbleSize;
            grid.dataset.originalBubbleFontSize = fontSize * 0.7;
            grid.dataset.originalCellGapHorizontal = cellGapHorizontal;
            grid.dataset.originalCellGapVertical = cellGapVertical;
            grid.dataset.originalContainerWidth = containerWidth;
            grid.dataset.originalContainerHeight = containerHeight;
            grid.dataset.originalBorderWidth = borderWidth;
            grid.dataset.originalGridPadding = gridPadding;

            addElementEventListeners(grid);
            formContainer.appendChild(grid);
        }

        function toggleBubbleVisibility(bubble) {
            const isVisible = bubble.dataset.visible === 'true';
            
            if (isVisible) {
                
                bubble.style.opacity = '0.3';
                bubble.style.backgroundColor = '#f7fafc';
                bubble.style.borderColor = '#cbd5e0';
                bubble.style.color = '#a0aec0';
                bubble.dataset.visible = 'false';
                bubble.title = 'Кликните для показа кружка';
            } else {
                
                bubble.style.opacity = '1';
                bubble.style.backgroundColor = 'white';
                bubble.style.borderColor = '#2d3748';
                bubble.style.color = '#2d3748';
                bubble.dataset.visible = 'true';
                bubble.title = 'Кликните для скрытия кружка';
            }
        }

        function createColumnContainer(questions, options, bubbleSize, fontSize, cellGapHorizontal, cellGapVertical, gridPadding, borderWidth, startQuestion = 1) {
            
            const column = document.createElement('div');
            column.className = 'column-container';
            column.style.border = borderWidth + 'px solid #2E3440';
            column.style.padding = gridPadding + 'px';
            column.style.background = 'white';
            column.style.position = 'relative';
            column.style.width = 'fit-content';
            column.style.height = 'fit-content';
            
            const containerWidth = (bubbleSize * options) + (cellGapHorizontal * (options - 1));
            const containerHeight = (bubbleSize * questions) + (cellGapVertical * (questions - 1));
            
            const bubblesContainer = document.createElement('div');
            bubblesContainer.style.position = 'relative';
            bubblesContainer.style.width = containerWidth + 'px';
            bubblesContainer.style.height = containerHeight + 'px';
            
            createBubblesInContainer(bubblesContainer, questions, options, bubbleSize, fontSize, cellGapHorizontal, cellGapVertical, startQuestion);
            
            column.appendChild(bubblesContainer);
            return column;
        }

        function createBubblesInContainer(container, questions, options, bubbleSize, fontSize, cellGapHorizontal, cellGapVertical, startQuestion) {
            for (let q = 0; q < questions; q++) {
                for (let o = 1; o <= options; o++) {
                    const bubble = document.createElement('div');
                    bubble.className = 'bubble';
                    bubble.textContent = `${startQuestion + q}.${o}`;
                    bubble.style.width = bubbleSize + 'px';
                    bubble.style.height = bubbleSize + 'px';
                    bubble.style.fontSize = (fontSize * 0.7) + 'px';
                    bubble.style.position = 'absolute';
                    
                    
                    const x = (o - 1) * (bubbleSize + cellGapHorizontal);
                    const y = q * (bubbleSize + cellGapVertical);
                    
                    bubble.style.left = x + 'px';
                    bubble.style.top = y + 'px';
                    bubble.style.cursor = 'pointer';
                    bubble.dataset.visible = 'true';
                    
                    
                    bubble.addEventListener('click', function(e) {
                        e.stopPropagation();
                        toggleBubbleVisibility(this);
                    });
                    
                    container.appendChild(bubble);
                }
            }
        }

        function addEmptyRowToContainer(container, options, bubbleSize, fontSize, cellGapHorizontal, cellGapVertical) {
            
            const bubblesContainer = container.querySelector('div[style*="position: relative"]');
            if (!bubblesContainer) return;
            
            
            const existingBubbles = bubblesContainer.querySelectorAll('.bubble:not(.empty-bubble)');
            const questionsInColumn = Math.ceil(existingBubbles.length / options);
            
            
            const newRowY = questionsInColumn * (bubbleSize + cellGapVertical);
            
            
            for (let o = 1; o <= options; o++) {
                const emptyBubble = document.createElement('div');
                emptyBubble.className = 'bubble empty-bubble';
                emptyBubble.style.width = bubbleSize + 'px';
                emptyBubble.style.height = bubbleSize + 'px';
                emptyBubble.style.fontSize = (fontSize * 0.7) + 'px';
                emptyBubble.style.position = 'absolute';
                emptyBubble.style.opacity = '0.3';
                emptyBubble.style.backgroundColor = '#f0f0f0';
                emptyBubble.style.borderColor = '#ccc';
                emptyBubble.style.cursor = 'default';
                emptyBubble.style.border = '3px solid #ccc';
                emptyBubble.style.borderRadius = '50%';
                emptyBubble.style.display = 'flex';
                emptyBubble.style.alignItems = 'center';
                emptyBubble.style.justifyContent = 'center';
                
                
                const x = (o - 1) * (bubbleSize + cellGapHorizontal);
                emptyBubble.style.left = x + 'px';
                emptyBubble.style.top = newRowY + 'px';
                
                bubblesContainer.appendChild(emptyBubble);
            }
            
            
            const newContainerHeight = (questionsInColumn + 1) * (bubbleSize + cellGapVertical) - cellGapVertical;
            bubblesContainer.style.height = newContainerHeight + 'px';
        }

        function addElementEventListeners(element) {
            
            element.addEventListener('click', (e) => {
                if (e.target !== element && element.contains(e.target)) {
                    e.stopPropagation();
                    selectElement(element);
                    return;
                }
                
                if (e.target.classList.contains('resize-handle')) {
                    return;
                }
                selectElement(element);
            });

            
            const selectionHandle = element.querySelector('.selection-handle');
            if (selectionHandle) {
                selectionHandle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectElement(element);
                });
            }

            
            element.addEventListener('mousedown', (e) => {
                if (e.target !== element && element.contains(e.target)) {
                    e.stopPropagation();
                    if (e.target.classList.contains('resize-handle')) {
                        startResizing(e, element, e.target.classList[1]);
                    } else {
                        startDragging(e, element);
                    }
                    return;
                }
                
                if (e.target.classList.contains('resize-handle')) {
                    startResizing(e, element, e.target.classList[1]);
                } else {
                    startDragging(e, element);
                }
            });

            
            element.addEventListener('wheel', (e) => {
                e.preventDefault();
                if (selectedElement === element) {
                    const scaleFactor = e.deltaY > 0 ? 0.9 : 1.1;
                    scaleElement(element, scaleFactor);
                }
            });

            
            element.addEventListener('contextmenu', (e) => e.preventDefault());
        }

        function selectElement(element) {
            if (selectedElement) {
                selectedElement.classList.remove('selected');
            }

            selectedElement = element;
            element.classList.add('selected');

            showElementProperties(element);
        }

        function showElementProperties(element) {
            objectControlPanel.style.display = 'block';
            
            const rect = element.getBoundingClientRect();
            const containerRect = formContainer.getBoundingClientRect();
            
            
            const sliders = {
                x: Math.round(rect.left - containerRect.left),
                y: Math.round(rect.top - containerRect.top),
                'font-size': parseInt(element.style.fontSize) || 18,
                scale: 100 
            };

           
            Object.keys(sliders).forEach(key => {
                const slider = document.getElementById(`slider-${key}`);
                const value = document.getElementById(`slider-${key}-value`);
                
                if (!slider) {
                    console.warn(`Constructor: Slider element 'slider-${key}' not found during setup`);
                    return;
                }
                if (!value) {
                    console.warn(`Constructor: Value element 'slider-${key}-value' not found during setup`);
                    return;
                }
                
                try {
                    slider.value = sliders[key];
                    if (key === 'scale') {
                        value.textContent = sliders[key] + '%';
                    } else {
                        value.textContent = sliders[key] + 'px';
                    }
                } catch (error) {
                    console.error(`Constructor: Error setting slider ${key}:`, error);
                }
            });
        }

        function updateElementProperty() {
            if (!selectedElement) return;

            const x = parseInt(document.getElementById('prop-x').value) || 0;
            const y = parseInt(document.getElementById('prop-y').value) || 0;
            const width = parseInt(document.getElementById('prop-width').value) || 100;
            const height = parseInt(document.getElementById('prop-height').value) || 30;
            const fontSize = parseInt(document.getElementById('prop-font-size').value) || 18;

            selectedElement.style.left = x + 'px';
            selectedElement.style.top = y + 'px';
            selectedElement.style.width = width + 'px';
            selectedElement.style.height = height + 'px';
            selectedElement.style.fontSize = fontSize + 'px';
        }

        function startDragging(e, element) {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            startLeft = parseInt(element.style.left) || 0;
            startTop = parseInt(element.style.top) || 0;

            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDragging);
        }

        function drag(e) {
            if (!isDragging) return;

            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;

            selectedElement.style.left = (startLeft + deltaX) + 'px';
            selectedElement.style.top = (startTop + deltaY) + 'px';

            if (selectedElement) {
                showElementProperties(selectedElement);
            }
        }

        function startResizing(e, element, handle) {
            isResizing = true;
            resizeHandle = handle;
            startX = e.clientX;
            startY = e.clientY;
            startWidth = element.offsetWidth;
            startHeight = element.offsetHeight;
            startLeft = parseInt(element.style.left) || 0;
            startTop = parseInt(element.style.top) || 0;

            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResizing);
        }

        function resize(e) {
            if (!isResizing) return;

            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;

            let newWidth = startWidth;
            let newHeight = startHeight;
            let newLeft = startLeft;
            let newTop = startTop;

            switch (resizeHandle) {
                case 'se':
                    newWidth = startWidth + deltaX;
                    newHeight = startHeight + deltaY;
                    break;
                case 'sw':
                    newWidth = startWidth - deltaX;
                    newHeight = startHeight + deltaY;
                    newLeft = startLeft + deltaX;
                    break;
                case 'ne':
                    newWidth = startWidth + deltaX;
                    newHeight = startHeight - deltaY;
                    newTop = startTop + deltaY;
                    break;
                case 'nw':
                    newWidth = startWidth - deltaX;
                    newHeight = startHeight - deltaY;
                    newLeft = startLeft + deltaX;
                    newTop = startTop + deltaY;
                    break;
            }

            newWidth = Math.max(50, newWidth);
            newHeight = Math.max(30, newHeight);

            selectedElement.style.width = newWidth + 'px';
            selectedElement.style.height = newHeight + 'px';
            selectedElement.style.left = newLeft + 'px';
            selectedElement.style.top = newTop + 'px';

            if (selectedElement) {
                showElementProperties(selectedElement);
            }
        }

        function stopDragging() {
            isDragging = false;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDragging);
        }

        function stopResizing() {
            isResizing = false;
            resizeHandle = null;
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResizing);
        }

        function scaleElement(element, factor) {
            if (!element.dataset.originalWidth) {
                element.dataset.originalWidth = element.offsetWidth;
                element.dataset.originalHeight = element.offsetHeight;
                element.dataset.originalFontSize = parseInt(element.style.fontSize) || 18;
                element.dataset.originalPadding = parseInt(getComputedStyle(element).padding) || 20;
                element.dataset.originalGap = parseInt(getComputedStyle(element).gap) || 20;
                element.dataset.originalBorderWidth = parseInt(getComputedStyle(element).borderWidth) || 3;
            }
            
            const originalWidth = parseInt(element.dataset.originalWidth);
            const originalHeight = parseInt(element.dataset.originalHeight);
            const originalFontSize = parseInt(element.dataset.originalFontSize);
            const originalPadding = parseInt(element.dataset.originalPadding);
            const originalGap = parseInt(element.dataset.originalGap);
            const originalBorderWidth = parseInt(element.dataset.originalBorderWidth);
            
            const currentScale = element.dataset.currentScale ? parseFloat(element.dataset.currentScale) : 1;
            const newScale = currentScale * factor;
            const finalScale = Math.max(0.3, Math.min(3, newScale));
            element.dataset.currentScale = finalScale;
            
            const newWidth = Math.round(originalWidth * finalScale);
            const newHeight = Math.round(originalHeight * finalScale);
            const newFontSize = Math.round(originalFontSize * finalScale);
            const newPadding = Math.round(originalPadding * finalScale);
            const newGap = Math.round(originalGap * finalScale);
            const newBorderWidth = Math.round(originalBorderWidth * finalScale);
            
            element.style.width = newWidth + 'px';
            element.style.height = newHeight + 'px';
            element.style.fontSize = newFontSize + 'px';
            element.style.padding = newPadding + 'px';
            element.style.gap = newGap + 'px';
            element.style.borderWidth = newBorderWidth + 'px';
            
            if (element.classList.contains('bubbles-grid')) {
                scaleBubblesGrid(element, finalScale, originalFontSize);
            }
            
            if (selectedElement === element) {
                showElementProperties(element);
            }
        }

        function scaleBubblesGrid(grid, scale, originalFontSize) {
            const bubbles = grid.querySelectorAll('.bubble');
            
            const originalBubbleSize = parseInt(grid.dataset.originalBubbleSize) || 50;
            const originalBubbleFontSize = parseInt(grid.dataset.originalBubbleFontSize) || originalFontSize * 0.7;
            const originalCellGapHorizontal = parseInt(grid.dataset.originalCellGapHorizontal) || 20;
            const originalCellGapVertical = parseInt(grid.dataset.originalCellGapVertical) || 20;
            const originalGridPadding = parseInt(grid.dataset.originalGridPadding) || 5;
            const originalContainerWidth = parseInt(grid.dataset.originalContainerWidth) || 250;
            const originalContainerHeight = parseInt(grid.dataset.originalContainerHeight) || 200;
            const originalBorderWidth = parseInt(grid.dataset.originalBorderWidth) || 7;
            
            const newBubbleSize = Math.round(originalBubbleSize * scale);
            const newBubbleFontSize = Math.round(originalBubbleFontSize * scale);
            const newCellGapHorizontal = Math.round(originalCellGapHorizontal * scale);
            const newCellGapVertical = Math.round(originalCellGapVertical * scale);
            const newGridPadding = Math.round(originalGridPadding * scale);
            const newBorderWidth = Math.round(originalBorderWidth * scale);
            
            const questions = Math.ceil(bubbles.length / 5);
            const options = 5;
            
            bubbles.forEach((bubble, index) => {
                const q = Math.floor(index / options) + 1;
                const o = (index % options) + 1;
                
                bubble.style.width = newBubbleSize + 'px';
                bubble.style.height = newBubbleSize + 'px';
                bubble.style.fontSize = newBubbleFontSize + 'px';
                
                const x = (o - 1) * (newBubbleSize + newCellGapHorizontal);
                const y = (q - 1) * (newBubbleSize + newCellGapVertical);
                
                bubble.style.left = x + 'px';
                bubble.style.top = y + 'px';
                
                const isVisible = bubble.dataset.visible === 'true';
                if (!isVisible) {
                    bubble.style.opacity = '0.3';
                    bubble.style.backgroundColor = '#f7fafc';
                    bubble.style.borderColor = '#cbd5e0';
                    bubble.style.color = '#a0aec0';
                }
            });
            
            const bubblesContainer = grid.querySelector('div[style*="position: relative"]');
            if (bubblesContainer) {
                const newContainerWidth = Math.round(originalContainerWidth * scale);
                const newContainerHeight = Math.round(originalContainerHeight * scale);
                bubblesContainer.style.width = newContainerWidth + 'px';
                bubblesContainer.style.height = newContainerHeight + 'px';
            }
            
            grid.style.padding = newGridPadding + 'px';
            grid.style.borderWidth = newBorderWidth + 'px';
            grid.style.width = 'fit-content';
        }

        
        function hideSelectionElements() {
            const selectionElements = document.querySelectorAll('[data-hide-on-save="true"]');
            selectionElements.forEach(el => {
                el.style.display = 'none';
            });
        }

        
        function showSelectionElements() {
            const selectionElements = document.querySelectorAll('[data-hide-on-save="true"]');
            selectionElements.forEach(el => {
                el.style.display = 'block';
            });
        }

        

        async function saveAsImage() {
            try {
                console.log('Constructor: PNG with background save button clicked');
                
                
                if (typeof html2canvas === 'undefined') {
                    throw new Error('html2canvas library not loaded');
                }
                
                
                if (window.Android && window.Android.log) {
                    window.Android.log('PNG with background save button clicked');
                }
                
                
                hideSelectionElements();
                
                console.log('Constructor: Creating canvas for PNG with background...');
                const canvas = await html2canvas(formContainer, {
                    backgroundColor: 'white',
                    scale: 2,
                    logging: true,
                    useCORS: true
                });
                
                console.log('Constructor: Canvas created, size:', canvas.width, 'x', canvas.height);
                
                
                showSelectionElements();
                
                const imgData = canvas.toDataURL('image/png');
                console.log('Constructor: Image data created, length:', imgData.length);
                
                
                if (window.Android && window.Android.saveImage) {
                    const base64 = imgData.split(',')[1];
                    console.log('Constructor: Base64 data ready, length:', base64.length);
                    window.Android.saveImage(base64, `чистый бланк с фоном.png`);
                } else {
                    console.warn('Constructor: Android interface not available, saving locally');
                    const link = document.createElement('a');
                    link.download = `чистый бланк с фоном.png`;
                    link.href = imgData;
                    link.click();
                }
                
            } catch (error) {
                console.error('Constructor: Error saving PNG with background:', error);
                if (window.Android && window.Android.log) {
                    window.Android.log('PNG save error: ' + error.message);
                }
            }
        }

        async function saveAsPNG() {
            try {
                console.log('Constructor: PNG without background save button clicked');
                
                
                if (typeof html2canvas === 'undefined') {
                    throw new Error('html2canvas library not loaded');
                }
                
                
                if (window.Android && window.Android.log) {
                    window.Android.log('PNG without background save button clicked');
                }
                
                
                hideSelectionElements();
                
                
                const originalBackground = formContainer.style.background;
                const originalBorder = formContainer.style.border;
                const originalBorderRadius = formContainer.style.borderRadius;
                const originalBoxShadow = formContainer.style.boxShadow;
                
                
                formContainer.style.background = 'transparent';
                formContainer.style.border = 'none';
                formContainer.style.borderRadius = '0';
                formContainer.style.boxShadow = 'none';
                
                
                const allElements = formContainer.querySelectorAll('*');
                const originalStyles = new Map();
                
                allElements.forEach(element => {
                    const computedStyle = window.getComputedStyle(element);
                    if (computedStyle.backgroundColor === 'rgb(255, 255, 255)' || 
                        computedStyle.background === 'white' ||
                        element.style.backgroundColor === 'white') {
                        
                        originalStyles.set(element, {
                            background: element.style.background,
                            backgroundColor: element.style.backgroundColor
                        });
                        
                        element.style.background = 'transparent';
                        element.style.backgroundColor = 'transparent';
                    }
                });
                
                console.log('Constructor: Creating canvas for PNG without background...');
                const canvas = await html2canvas(formContainer, {
                    backgroundColor: null,
                    scale: 2,
                    logging: true,
                    useCORS: true
                });
                
                
                formContainer.style.background = originalBackground;
                formContainer.style.border = originalBorder;
                formContainer.style.borderRadius = originalBorderRadius;
                formContainer.style.boxShadow = originalBoxShadow;
                
                
                originalStyles.forEach((styles, element) => {
                    element.style.background = styles.background;
                    element.style.backgroundColor = styles.backgroundColor;
                });
                
                console.log('Constructor: Canvas created, size:', canvas.width, 'x', canvas.height);
                
                
                showSelectionElements();
                
                const imgData = canvas.toDataURL('image/png');
                console.log('Constructor: Image data created, length:', imgData.length);
                
                
                if (window.Android && window.Android.saveImage) {
                    const base64 = imgData.split(',')[1];
                    console.log('Constructor: Base64 data ready, length:', base64.length);
                    window.Android.saveImage(base64, `чистый бланк без фона.png`);
                } else {
                    console.warn('Constructor: Android interface not available, saving locally');
                    const link = document.createElement('a');
                    link.download = `чистый бланк без фона.png`;
                    link.href = imgData;
                    link.click();
                }
                
            } catch (error) {
                console.error('Constructor: Error saving PNG without background:', error);
                if (window.Android && window.Android.log) {
                    window.Android.log('PNG save error: ' + error.message);
                }
            }
        }

        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }



        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.form-element') && !e.target.closest('#object-control-panel')) {
                objectControlPanel.style.display = 'none';
                if (selectedElement) {
                    selectedElement.classList.remove('selected');
                    selectedElement = null;
                }
            }
        });
    </script>
</body>
</html>
